"use strict";(self.webpackChunkliwx_docs=self.webpackChunkliwx_docs||[]).push([[104],{9964:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>r,data:()=>d});var p=a(641);const t=a.p+"assets/img/definedProperty.6ba79f15.jpg",e=a.p+"assets/img/proxy.bbd7ada1.jpg",o=a.p+"assets/img/Vue响应式依赖数据结构.1c0163c3.jpg",c=(0,p.Fv)('<h1 id="vue-的响应式" tabindex="-1"><a class="header-anchor" href="#vue-的响应式"><span>Vue 的响应式</span></a></h1><p>Vue2 使用了 Object.defineProperty()来实现响应式，Vue3 使用了 ES6 的 Proxy 来实现响应式。</p><p><strong>Object.defineProperty()</strong></p><p><img src="'+t+'" alt=""></p><p><strong>为什么 Vue2 中数组和对象的变动无法做到响应式？</strong></p><p>因为 defineProperty 中只有 <code>getter</code> , <code>setter</code>.没有<code>create</code>和<code>delete</code>。所以数组内部的操作和对象中的操作是无法监听到的</p><p>使用 definedProperty 有三个主要的问题</p><ol><li>不能监听数组的变化 <blockquote><p>无法监听到下标的变化，导致数组下边添加元素不能实现响应</p></blockquote></li><li>不许遍历对象的每个属性 <blockquote><p>只能劫持对象的属性，对每个对象的每个属性进行遍历 如果属性值是对象，还需要深度遍历。Proxy 是劫持整个对象，并生成一个新的对象</p></blockquote></li><li>必须深层次遍历嵌套对象</li></ol><p><strong>Proxy</strong></p><p><img src="'+e+'" alt=""></p><h2 id="依赖收集和依赖分发" tabindex="-1"><a class="header-anchor" href="#依赖收集和依赖分发"><span><strong>依赖收集和依赖分发</strong></span></a></h2><p><strong>发布 - 订阅模式</strong> 发布 - 订阅模式是一种设计模式，它定义了一种一对多的关系，让多个观察者对象同时监听某一个主体对象，当主体对象的状态发生变化时，它会通知所有观察者对象，使它们能够自动更新自己。 Vue3 的响应式原理就是基于发布 - 订阅模式实现的，它通过 Proxy 对象来代理原始数据对象，拦截其读取和修改的操作，从而实现对数据的依赖收集和依赖分发。</p><h3 id="依赖收集" tabindex="-1"><a class="header-anchor" href="#依赖收集"><span>依赖收集</span></a></h3><p>依赖收集的目的是为了简历数据和副作用函数之间的映射关系。让数据知道哪些副作用函数依赖于他，当数据变化是，通知副作用函数进行更新</p>',14),i=(0,p.Lk)("p",null,"副作用函数是指那些依赖于响应书数据变化而执行的函数。例如：",-1),l=(0,p.Lk)("ol",null,[(0,p.Lk)("li",null,"渲染函数：负责将数据渲染至视图"),(0,p.Lk)("li",null,"计算属性：依赖于响应式数据，当数据变化时，重新计算并返回新的值"),(0,p.Lk)("li",null,"侦听器：监听响应式数据的变化，并在变化时执行回调函数"),(0,p.Lk)("li",null,"自定义函数：在函数内部使用了响应式数据，当数据变化时，函数会重新执行")],-1),u=(0,p.Fv)('<p>函数是 Vue3 响应式系统的核心部分之一，它的主要作用是跟踪对响应式对象属性的访问。</p><p>当你访问一个响应式对象的属性时，<code>track</code>函数会被调用。它会检查当前是否有一个活动的<code>effect（副作用函数）</code>。如果有，那么这个<code>effect</code>就会被添加到这个属性的依赖列表中。这样，当这个属性的值发生变化时，所有依赖于这个属性的<code>effect</code>就会被重新执行（trigger 函数）。</p><p><code>track</code> 函数的实现如下：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**\n * 跟踪对响应式属性的访问。\n *\n * 这将检查当前正在运行的效果，并将其记录为dep，\n * dep记录了所有依赖于响应式属性的效果。\n *\n * <span class="token keyword">@param</span> <span class="token parameter">target</span> - 持有响应式属性的对象。\n * <span class="token keyword">@param</span> <span class="token parameter">type</span> - 定义对响应式属性的访问类型。\n * <span class="token keyword">@param</span> <span class="token parameter">key</span> - 要跟踪的响应式属性的标识符。\n */</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> object<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// shouldTrack和activeEffect都为真时，才进行跟踪</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 从targetMap中获取目标对象的依赖映射</span>\n    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n    <span class="token comment">// 如果目标对象没有依赖映射，则为其创建一个</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 从依赖映射中获取属性的依赖</span>\n    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token comment">// 如果属性没有依赖，则为其创建一个</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> depsMap<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 跟踪效果</span>\n    <span class="token comment">// activeEffect - 当前活动的效果</span>\n    <span class="token comment">// dep - 属性的依赖</span>\n    <span class="token comment">// __DEV__ ? {target, type, key} : void 0 - 在开发模式下，传递额外的调试信息</span>\n    <span class="token function">trackEffect</span><span class="token punctuation">(</span>\n      activeEffect<span class="token punctuation">,</span>\n      dep<span class="token punctuation">,</span>\n      __DEV__\n        <span class="token operator">?</span> <span class="token punctuation">{</span>\n            target<span class="token punctuation">,</span>\n            type<span class="token punctuation">,</span>\n            key<span class="token punctuation">,</span>\n          <span class="token punctuation">}</span>\n        <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="依赖分发" tabindex="-1"><a class="header-anchor" href="#依赖分发"><span>依赖分发</span></a></h3><blockquote><p>依赖分发的目的是为了在数据发生变化时，触发依赖于该数据的副作用函数进行更新，从而实现数据和视图的同步。</p></blockquote><p><code>trigger</code>函数在 Vue3 的响应式系统中起着关键的作用，它负责在数据发生变化时触发更新。以下是<code>trigger</code>函数的详细工作流程：</p><ul><li><strong>获取依赖映射</strong>.首先，<code>trigger</code>函数会从<code>targetMap</code>中获取目标对象的依赖映射。<code>targetMap</code> 是一个全局的 <code>WeakMap</code>，它存储了所有响应式对象及其对应的依赖映射。</li><li><strong>确定需要触发的依赖</strong>.然后，<code>trigger</code>函数会根据触发类型（<code>type</code>）和属性键（<code>key</code>）来确定需要触发的依赖。例如，如果触发类型是 <code>SET</code>，那么只有依赖于该属性的依赖会被触发。</li><li><strong>触发依赖的效果</strong>。trigger 函数会遍历所有需要触发的依赖，并执行其中存储的效果。这些效果通常是重新计算计算属性的值或重新渲染组件。</li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**\n * 找到与目标（或特定属性）相关的所有依赖，并触发其中存储的效果。\n *\n * <span class="token keyword">@param</span> <span class="token parameter">target</span> - 响应式对象。\n * <span class="token keyword">@param</span> <span class="token parameter">type</span> - 定义需要触发效果的操作类型。\n * <span class="token keyword">@param</span> <span class="token parameter">key</span> - 可用于定位目标对象中的特定响应式属性。\n */</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>\n  <span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> object<span class="token punctuation">,</span>\n  <span class="token literal-property property">type</span><span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>\n  key<span class="token operator">?</span><span class="token operator">:</span> unknown<span class="token punctuation">,</span>\n  newValue<span class="token operator">?</span><span class="token operator">:</span> unknown<span class="token punctuation">,</span>\n  oldValue<span class="token operator">?</span><span class="token operator">:</span> unknown<span class="token punctuation">,</span>\n  oldTarget<span class="token operator">?</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>unknown<span class="token punctuation">,</span> unknown<span class="token operator">&gt;</span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span></span>\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从targetMap中获取目标对象的依赖映射</span>\n  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 如果目标对象没有依赖映射，说明它从未被跟踪过，直接返回</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> <span class="token literal-property property">deps</span><span class="token operator">:</span> <span class="token punctuation">(</span>Dep <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 如果操作类型是CLEAR，说明集合正在被清空，触发目标的所有效果</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>depsMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 如果目标是数组且键名是&#39;length&#39;，则触发长度变化的效果</span>\n    <span class="token keyword">const</span> newLength <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">&gt;=</span> newLength<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对于SET、ADD、DELETE操作，触发相应的效果</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 对于ADD、DELETE、Map.SET操作，也要触发迭代键的效果</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token operator">:</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 数组中添加了新索引 -&gt; 长度变化</span>\n          deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;length&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token operator">:</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token operator">:</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 暂停调度</span>\n  <span class="token function">pauseScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发所有依赖的效果</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">triggerEffects</span><span class="token punctuation">(</span>\n        dep<span class="token punctuation">,</span>\n        DirtyLevels<span class="token punctuation">.</span>Dirty<span class="token punctuation">,</span>\n        __DEV__\n          <span class="token operator">?</span> <span class="token punctuation">{</span>\n              target<span class="token punctuation">,</span>\n              type<span class="token punctuation">,</span>\n              key<span class="token punctuation">,</span>\n              newValue<span class="token punctuation">,</span>\n              oldValue<span class="token punctuation">,</span>\n              oldTarget<span class="token punctuation">,</span>\n            <span class="token punctuation">}</span>\n          <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 重置调度</span>\n  <span class="token function">resetScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="批量异步更新" tabindex="-1"><a class="header-anchor" href="#批量异步更新"><span><strong>批量异步更新</strong></span></a></h3><blockquote><p>在 Vue 的响应式系统中，当数据发生变化时，trigger 函数会立即触发所有依赖于该数据的 effect。但是，如果在一个事件循环 中，同一个数据被多次修改，那么同一个 effect 就会被多次触发，这可能会导致不必要的计算和渲染。Vue 是如何解决这个问题 的？如果你要设计一个批量异步更新的机制，你会如何设计？</p></blockquote><p>Vue 使用了一个异步队列来实现批量异步更新。当数据发生变化时，Vue 并不会立即触发更新，而是将需要更新的 <code>watcher</code> 添加到一个队列中。然后，Vue 会在事件循环的下一个 <code>tick</code> 中，清空这个队列并执行所有的 <code>watcher</code>。这样，如果在一个事件循环中，同一个数据被多次修改，同一个 <code>watcher</code> 也只会被执行一次。此外，<strong>由于 Vue 在执行 watcher 之前会对队列进行排序，保证了父组件总是在子组件之前更新，计算属性总是在其依赖的属性之前更新，从而避免了不必要的重复更新。</strong></p><h3 id="依赖管理的数据结构-简单原理-非-vue-底层源码" tabindex="-1"><a class="header-anchor" href="#依赖管理的数据结构-简单原理-非-vue-底层源码"><span>依赖管理的数据结构(简单原理，非 vue 底层源码)</span></a></h3><p><img src="'+o+'" alt=""></p><ol><li>weakMap: 存储响应式对象和它的依赖关系</li><li>Map: 存储响应式对象的属性和它的依赖关系</li><li>Set: 存储依赖关系中的副作用函数</li></ol><p>创建依赖类 Depend 来管理依赖</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// 依赖类</span>\n<span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 添加依赖</span>\n  <span class="token function">addDepend</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 添加依赖2</span>\n  <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 通知依赖函数执行</span>\n  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> effect <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">//监听对象的变化</span>\n<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span>\n<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\nactiveEffect <span class="token operator">=</span> fn\n  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  activeEffect <span class="token operator">=</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 专门管理依赖的函数</span>\n<span class="token keyword">let</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">getDepend</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取对象对应的依赖映射</span>\n  <span class="token keyword">let</span> objMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>objMap<span class="token punctuation">)</span><span class="token punctuation">{</span>\n    objMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> objMap<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 获取对象属性对应的依赖</span>\n  <span class="token keyword">let</span> dep <span class="token operator">=</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    objMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> dep<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Vue2</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">//收集依赖</span>\n        <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n        <span class="token comment">//触发更新</span>\n        <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Vue3</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> reciever<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">//收集依赖</span>\n      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> reciever<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> reciever<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">//触发更新</span>\n      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> reciever<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',21),k={},r=(0,a(6262).A)(k,[["render",function(n,s){const a=(0,p.g2)("font");return(0,p.uX)(),(0,p.CE)("div",null,[c,(0,p.bF)(a,{color:"mediumaquamarine",size:"3"},{default:(0,p.k6)((()=>[(0,p.eW)("什么是副作用函数（effect）")])),_:1}),i,l,(0,p.bF)(a,{color:"mediumaquamarine",size:"3"},{default:(0,p.k6)((()=>[(0,p.eW)("track 函数")])),_:1}),u])}]]),d=JSON.parse('{"path":"/mianshi/Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F.html","title":"Vue 的响应式","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"依赖收集和依赖分发","slug":"依赖收集和依赖分发","link":"#依赖收集和依赖分发","children":[{"level":3,"title":"依赖收集","slug":"依赖收集","link":"#依赖收集","children":[]},{"level":3,"title":"依赖分发","slug":"依赖分发","link":"#依赖分发","children":[]},{"level":3,"title":"批量异步更新","slug":"批量异步更新","link":"#批量异步更新","children":[]},{"level":3,"title":"依赖管理的数据结构(简单原理，非 vue 底层源码)","slug":"依赖管理的数据结构-简单原理-非-vue-底层源码","link":"#依赖管理的数据结构-简单原理-非-vue-底层源码","children":[]}]}],"git":{},"filePathRelative":"mianshi/Vue的响应式.md"}')}}]);