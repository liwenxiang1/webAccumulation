"use strict";(self.webpackChunkliwx_docs=self.webpackChunkliwx_docs||[]).push([[2734],{5867:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>o,data:()=>c});var t=a(641);const e=[(0,t.Fv)('<h2 id="自定义-webpack-插件详解" tabindex="-1"><a class="header-anchor" href="#自定义-webpack-插件详解"><span>自定义 Webpack 插件详解</span></a></h2><p><strong>关键步骤</strong></p><ol><li><p>拿到 webpack 环境配置</p></li><li><p>告诉 webpack 插件在什么时机调用</p></li></ol><ul><li><p>**<code>compiler</code>对象：代表了完整的 webpack 环境配置。**这个对象在启用 webpack 时被一次性创建，并配置好所有可用的配置项，包括 <code>options</code>，<code>loader</code> 和 <code>plugin</code>。当在 <code>webpack</code>环境中应用一个插件时，插件将收到此<code>compailer</code> 对象的引用。可以使用它来访问 <code>webpack</code> 的主环境。</p></li><li><p>**compilation 对象：该对象代表了一次资源版本构建。**当运行 <code>webpack </code>开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 <code>compilation</code>，从而生成一组新的编译资源。一个 <code>compilation</code> 对象包含了当前的模块资源、编译生成资源、变化的文件等。<code>compilation</code> 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</p></li></ul><p><strong>钩子的本质就是事件</strong></p><ol><li>自定义 webpack plugins 声明一个 class ,实现构造函数，重写 apply 方法。在 hooks 上寻找时机添加行为</li></ol><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// First-webpack-plugin.js</span>\n<span class="token comment">//创建一个构造函数</span>\n<span class="token keyword">class</span> <span class="token class-name">FirstWebpackPlugin</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;TestPlugin&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;TestPlugin environment&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 3. 将我们的自定义插件导出</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> FirstWebpackPlugin<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用 new FirstWebpackPlugin()调用插件</li></ol><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">//webpack.config.js</span>\n<span class="token keyword">const</span> FirstWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./First-webpack-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">FirstWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;webpack&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="自定义-loader" tabindex="-1"><a class="header-anchor" href="#自定义-loader"><span>自定义 loader</span></a></h2><blockquote><p><code>同步 loader</code> <code>异步 loader</code> <code>raw loader</code> <code>pitch loader</code></p></blockquote><p><strong>同步 loader</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">//first-loader.js</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 第一个参数，error, 是否有错误，没错null, 有错就把错误传递出去，如果loader出错了。会把错误传递出去</span>\n  <span class="token comment">// 第二个参数：content,处理后的内容。</span>\n  <span class="token comment">// 第三个参数：map  source-map， 继续传递 source-map</span>\n  <span class="token comment">// 第四个参数： meta, 给其他别的loader传递的数据，可以继承传递出去</span>\n  <span class="token keyword">let</span> code <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">console\\.log\\(.*?\\);?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code> <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>\n        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">&#39;./loaders/first-loader.js&#39;</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同步 loader 注意：同步 loader 中不能进行异步操作，会报错。下一个 loader 拿到的值是 undefined。</p><p><strong>异步 loader</strong></p><blockquote><p>异步 loader, 一定会等待这个异步 loader 做完，才会执行下一个 loader,**const callback = this.async();**是关键代码</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// 异步loader</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;test2&#39;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;test2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>raw loader</strong></p><blockquote><p>raw loader 接收到的 content 是 buffer (二进制数据); 当我们处理图片，字体图标的时候会使用定义这种 loader;</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// raw loader</span>\n<span class="token comment">// raw loader接收到的 content 是 buffer数据（二进制数据）</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;raw loader接收到的数据:&#39;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收的数据是 buffer数据</span>\n  <span class="token keyword">return</span> content<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//关键代码</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>pitch loader</strong></p><blockquote><p>pitch loader 要求在暴露的对象中添加 pitch 方法，pitch 方法是在执行 loader 之前执行 <strong>loader API</strong></p></blockquote><blockquote><table><thead><tr><th style="text-align:center;">方法名</th><th style="text-align:center;">含义</th><th style="text-align:center;">用法</th></tr></thead><tbody><tr><td style="text-align:center;">this.async</td><td style="text-align:center;">异步回调 loader,返回 this.callback</td><td style="text-align:center;">const callback = this.async()</td></tr><tr><td style="text-align:center;">this.callback</td><td style="text-align:center;">可以同步或者异步调用并返回多个结果的函数</td><td style="text-align:center;">this.callback(err, content, sourceMap?, meta?)</td></tr><tr><td style="text-align:center;">this.getOptions(schema)</td><td style="text-align:center;">获取 loader 的 options</td><td style="text-align:center;">this.getOptions(schema)</td></tr><tr><td style="text-align:center;">this.emitFile</td><td style="text-align:center;">产生一个文件</td><td style="text-align:center;">this.emitFile(name,content,sourceMap)</td></tr><tr><td style="text-align:center;">this.utils.contextify</td><td style="text-align:center;">返回一个相对路径</td><td style="text-align:center;">this.utils.contextify(context, request)</td></tr><tr><td style="text-align:center;">this.utils.absolutify</td><td style="text-align:center;">返回一个绝对路径</td><td style="text-align:center;">this.utils.absolutify(context, request)</td></tr></tbody></table></blockquote>',24)],p={},o=(0,a(6262).A)(p,[["render",function(n,s){return(0,t.uX)(),(0,t.CE)("div",null,e)}]]),c=JSON.parse('{"path":"/mianshi/%E8%87%AA%E5%AE%9A%E4%B9%89Webpack%E7%9A%84plugins%E8%AF%A6%E8%A7%A3%E5%92%8Cloader.html","title":"","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"自定义 Webpack 插件详解","slug":"自定义-webpack-插件详解","link":"#自定义-webpack-插件详解","children":[]},{"level":2,"title":"自定义 loader","slug":"自定义-loader","link":"#自定义-loader","children":[]}],"git":{},"filePathRelative":"mianshi/自定义Webpack的plugins详解和loader.md"}')}}]);